"""Промпты для генерации нумерологических отчётов."""
import logging
from typing import List, Dict, Any
from datetime import datetime

logger = logging.getLogger(__name__)


def format_participant_data(participant: Dict[str, Any]) -> str:
    """
    Форматирование данных участника для промпта.

    Args:
        participant: Словарь с данными участника

    Returns:
        str: Отформатированная строка с данными
    """
    full_name = participant.get("full_name", "Не указано")

    # Обработка даты рождения (может быть datetime или строка)
    birth_date = participant.get("birth_date")
    if isinstance(birth_date, datetime):
        birth_date_str = birth_date.strftime("%d.%m.%Y")
    elif birth_date:
        birth_date_str = str(birth_date)
    else:
        birth_date_str = "Не указано"

    # Обработка времени рождения (может быть datetime или None)
    birth_time = participant.get("birth_time")
    if isinstance(birth_time, datetime):
        birth_time_str = birth_time.strftime("%H:%M")
    elif birth_time:
        birth_time_str = str(birth_time)
    else:
        birth_time_str = "Не указано"

    birth_place = participant.get("birth_place", "Не указано")

    return f"""Имя: {full_name}
Дата рождения: {birth_date_str}
Время рождения: {birth_time_str}
Место рождения: {birth_place}"""


# =============================================================================
# БЫСТРЫЙ АНАЛИЗ - АНАЛИТИЧЕСКИЙ (2-3 страницы)
# =============================================================================

QUICK_ANALYTICAL = """Ты профессиональный нумеролог. Сделай короткий аналитический отчёт.

Данные клиента:
{participant_data}

Проанализируй дату рождения, имя, используй книгу по нумерологии из базы знаний. Подготовь краткий отчёт на 2-3 страницы с основными характеристиками личности, кармическими задачами и рекомендациями."""


# =============================================================================
# БЫСТРЫЙ АНАЛИЗ - ШАМАНСКИЙ (2-3 страницы)
# =============================================================================

QUICK_SHAMANIC = """Ты древний шаман-нумеролог. Сделай короткий мистический отчёт.

Данные клиента:
{participant_data}

Проанализируй дату рождения, имя, используй книгу по нумерологии из базы знаний. Подготовь краткий отчёт на 2-3 страницы в мистическом стиле - кто он по судьбе, его духовная задача, предупреждения."""


# =============================================================================
# ГЛУБОКИЙ АНАЛИЗ - АНАЛИТИЧЕСКИЙ (10-15 страниц)
# =============================================================================

DEEP_ANALYTICAL = """Ты профессиональный нумеролог с многолетним опытом. Сделай крутой глубокий аналитический отчёт.

Данные клиента:
{participant_data}

Проанализируй дату рождения, имя, город рождения, время рождения. Используй всю книгу по нумерологии из базы знаний - все методы расчёта, все таблицы, все значения. Подготовь детальный отчёт на 10-15 страниц с полным разбором личности, кармы, предназначения, совместимости, здоровья, карьеры."""


# =============================================================================
# ГЛУБОКИЙ АНАЛИЗ - ШАМАНСКИЙ (10-15 страниц)
# =============================================================================

DEEP_SHAMANIC = """Ты древний шаман-видящий, читающий судьбы людей. Сделай крутой глубокий мистический отчёт.

Данные клиента:
{participant_data}

Проанализируй дату рождения, имя, город рождения, время рождения. Используй всю книгу по нумерологии из базы знаний - все методы, все тайные знания. Подготовь мистическое пророчество на 10-15 страниц - кто он по душе, его прошлые жизни, кармические уроки, духовный путь, предупреждения судьбы."""


# =============================================================================
# ПАРНЫЙ АНАЛИЗ - АНАЛИТИЧЕСКИЙ (10-15 страниц)
# =============================================================================

PAIR_ANALYTICAL = """Ты специалист по нумерологии отношений. Сделай крутой анализ совместимости пары.

Данные первого партнёра:
{participant_1_data}

Данные второго партнёра:
{participant_2_data}

Проанализируй обе даты рождения, имена, используй книгу по нумерологии из базы знаний. Подготовь детальный отчёт на 10-15 страниц о совместимости пары - их сильные стороны, слабые места, как строить отношения, рекомендации для гармонии."""


# =============================================================================
# ПАРНЫЙ АНАЛИЗ - ШАМАНСКИЙ (10-15 страниц)
# =============================================================================

PAIR_SHAMANIC = """Ты шаман, видящий судьбы влюблённых. Сделай крутой мистический анализ союза двух душ.

Данные первого партнёра:
{participant_1_data}

Данные второго партнёра:
{participant_2_data}

Проанализируй обе даты рождения, имена, используй книгу по нумерологии из базы знаний. Подготовь мистическое откровение на 10-15 страниц о судьбе их союза - кармические связи, уроки отношений, духовное предназначение пары, предупреждения."""


# =============================================================================
# СЕМЕЙНЫЙ АНАЛИЗ - АНАЛИТИЧЕСКИЙ (15-20 страниц)
# =============================================================================

FAMILY_ANALYTICAL = """Ты семейный нумеролог-консультант. Сделай крутой анализ семейной динамики.

Данные членов семьи:
{family_data}

Проанализируй даты рождения всех членов семьи, имена, используй книгу по нумерологии из базы знаний. Подготовь детальный отчёт на 15-20 страниц о семейной совместимости - роли каждого, взаимодействия, конфликты и решения, рекомендации для гармонии в семье."""


# =============================================================================
# СЕМЕЙНЫЙ АНАЛИЗ - ШАМАНСКИЙ (15-20 страниц)
# =============================================================================

FAMILY_SHAMANIC = """Ты шаман, видящий родовые связи и семейную карму. Сделай крутой мистический анализ семейного клана.

Данные членов семьи:
{family_data}

Проанализируй даты рождения всех членов семьи, имена, используй книгу по нумерологии из базы знаний. Подготовь мистическое откровение на 15-20 страниц о родовой карме - кармические связи семьи, духовные задачи рода, предупреждения для каждого члена семьи."""


# =============================================================================
# ФУНКЦИЯ ПОСТРОЕНИЯ ПРОМПТА
# =============================================================================

def build_numerology_prompt(
    tariff: str,
    style: str,
    participants: List[Dict[str, Any]]
) -> str:
    """
    Построение промпта для нумерологического анализа.

    Args:
        tariff: Тип тарифа ('quick', 'deep', 'pair', 'family')
        style: Стиль отчёта ('analytical', 'shamanic')
        participants: Список участников с данными

    Returns:
        str: Промпт для AI

    Raises:
        ValueError: Если неверная комбинация тарифа/стиля
    """
    # Выбор базового промпта
    prompt_map = {
        ('quick', 'analytical'): QUICK_ANALYTICAL,
        ('quick', 'shamanic'): QUICK_SHAMANIC,
        ('deep', 'analytical'): DEEP_ANALYTICAL,
        ('deep', 'shamanic'): DEEP_SHAMANIC,
        ('pair', 'analytical'): PAIR_ANALYTICAL,
        ('pair', 'shamanic'): PAIR_SHAMANIC,
        ('family', 'analytical'): FAMILY_ANALYTICAL,
        ('family', 'shamanic'): FAMILY_SHAMANIC,
    }

    base_prompt = prompt_map.get((tariff, style))

    if not base_prompt:
        raise ValueError(f"Unknown tariff/style combination: {tariff}/{style}")

    # Подстановка данных участников
    if tariff in ['quick', 'deep']:
        # Один участник
        participant_data = format_participant_data(participants[0])
        return base_prompt.format(participant_data=participant_data)

    elif tariff == 'pair':
        # Два участника
        participant_1_data = format_participant_data(participants[0])
        participant_2_data = format_participant_data(participants[1])
        return base_prompt.format(
            participant_1_data=participant_1_data,
            participant_2_data=participant_2_data
        )

    elif tariff == 'family':
        # Несколько участников
        family_data = ""
        for i, p in enumerate(participants, 1):
            family_data += f"\nЧЛЕН СЕМЬИ {i}:\n"
            family_data += format_participant_data(p)
            family_data += "\n"

        return base_prompt.format(family_data=family_data)
